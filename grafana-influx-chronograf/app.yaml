version: '2'
services:
  influxdb:
    image: influxdb:1.8.3
    ports:
      - '8086:8086'
    volumes:
      - influxdb-storage:/var/lib/influxdb
    environment:
      - INFLUXDB_DB=db0
      - INFLUXDB_ADMIN_USER=${INFLUXDB_USERNAME}
      - INFLUXDB_ADMIN_PASSWORD=${INFLUXDB_PASSWORD}
  chronograf:
    image: chronograf:latest
    ports:
      - '127.0.0.1:8888:8888'
    volumes:
      - chronograf-storage:/var/lib/chronograf
    depends_on:
      - influxdb
    environment:
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_USERNAME=${INFLUXDB_USERNAME}
      - INFLUXDB_PASSWORD=${INFLUXDB_PASSWORD}
  grafana:
    image: grafana/grafana:latest
    ports:
      - '3000:3000'
    volumes:
      - grafana-storage:/var/lib/grafana
      - ./grafana-provisioning/:/etc/grafana/provisioning
    depends_on:
      - influxdb
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USERNAME}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
volumes:
  influxdb-storage:
  chronograf-storage:
  grafana-storage:

---
apiVersion: v1
kind: Service
metadata:
  name: influxdb
spec:
  ports:
    - port: 8086
  selector:
    app: influxdb
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: influxdb
spec:
  selector:
    matchLabels:
      app: influxdb
  template:
    metadata:
      labels:
        app: influxdb
    spec:
      containers:
        - name: influxdb
          image: influxdb:latest
          ports: 
            - containerPort: 8086
          env:
            - name: INFLUXDB_DB
              value: db0
            - name: INFLUXDB_ADMIN_USER
              value: ${INFLUXDB_USERNAME}
            - name: INFLUXDB_ADMIN_PASSWORD
              value: ${INFLUXDB_PASSWORD}
          volumeMounts:
            - mountPath: "/var/lib/influxdb"
              name: influxdb-storage
---
apiVersion: v1
kind: Service
metadata:
  name: chronograf
spec:
  ports:
    - port: 8888
  selector:
    app: chronograf
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: chronograf
spec:
  selector:
    matchLabels:
      app: chronograf
  template:
    metadata:
      labels:
        app: chronograf
    spec:
      containers:
        - name: chronograf
          image: chronograf:latest
          ports: 
            - containerPort: 8888
          env:
            - name: INFLUXDB_URL
              value: http://influxdb:8086
            - name: INFLUXDB_USERNAME
              value: ${INFLUXDB_USERNAME}
            - name: INFLUXDB_PASSWORD
              value: ${INFLUXDB_PASSWORD}
          volumeMounts:
            - mountPath: "/var/lib/chronograf"
              name: chronograf-storage
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
spec:
  ports:
    - port: 3000
  selector:
    app: grafana
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
spec:
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      containers:
        - name: grafana
          image: grafana/grafana:latest
          ports: 
            - containerPort: 3000
          env:
            - name: GF_SECURITY_ADMIN_USER
              value: ${GRAFANA_USERNAME}
            - name: GF_SECURITY_ADMIN_PASSWORD
              value: ${GRAFANA_PASSWORD}
          volumeMounts:
            - mountPath: "/var/lib/grafana"
              name: grafana-storage
            - mountPath: "/etc/grafana/provisioning"
              name: grafana-provisioning
---
apiVersion: v1
kind: Service
metadata:
  name: influxdb
spec:
  ports:
    - port: 8086
  selector:
    app: influxdb
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: chronograf
spec:
  ports:
    - port: 8888
  selector:
    app: chronograf
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
spec:
  ports:
    - port: 3000
  selector:
    app: grafana
  type: ClusterIP
